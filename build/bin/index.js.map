{"version":3,"sources":["../../src/bin/index.js"],"names":["LOG","DEBUG","test","process","env","NODE_DEBUG","source","_source","output","_output","toc","_toc","watch","_watch","push","_push","typedef","_typedef","argv","find","a","console","log","exit","doc","justToc","ls","stream","isDirectory","Pedantry","isFile","docJs","stack","message","code","debounce","recursive","gitPush","setTimeout","promise","stdout","s","trim","git","args","stdio"],"mappings":"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","sourcesContent":["#!/usr/bin/env node\nimport { watch } from 'fs'\nimport { lstatSync, createReadStream } from 'fs'\nimport Pedantry from 'pedantry'\nimport { debuglog } from 'util'\nimport spawn from 'spawncommand'\nimport run from './run'\nimport getArgs from './get-args'\nimport runJs from './run-js'\n\nconst LOG = debuglog('doc')\nconst DEBUG = /doc/.test(process.env.NODE_DEBUG)\n\nconst {\n  source: _source,\n  output: _output,\n  toc: _toc,\n  watch: _watch,\n  push: _push,\n  typedef: _typedef,\n} = getArgs()\n\nif (process.argv.find(a => a == '-p') && !_push) {\n  console.log('Please specify a commit message.')\n  process.exit(1)\n}\n\nconst doc = async (source, output, justToc = false) => {\n  if (!source) {\n    console.log('Please specify an input file.') // print usage\n    process.exit(1)\n  }\n  const ls = lstatSync(source)\n  let stream\n  if (ls.isDirectory()) {\n    stream = new Pedantry(source)\n  } else if (ls.isFile()) {\n    stream = createReadStream(source)\n  }\n  await run(stream, output, justToc)\n}\n\nconst docJs = async (source, output) => {\n  if (!source) {\n    console.log('Please specify a JavaScript file.')\n    process.exit(1)\n  }\n  try {\n    await runJs(source, output)\n  } catch ({ stack, message }) {\n    DEBUG ? LOG(stack) : console.log(message)\n    process.exit(1)\n  }\n}\n\n\n(async () => {\n  if (_typedef) {\n    await docJs(_source, _output)\n    return\n  }\n  try {\n    await doc(_source, _output, _toc)\n  } catch ({ stack, message, code }) {\n    if (code == 'ENOENT') {\n      console.log('File %s does not exist.', _source)\n      process.exit(2)\n    }\n    DEBUG ? LOG(stack) : console.log(message)\n  }\n  let debounce = false\n  if (_watch || _push) {\n    watch(_source, { recursive: true }, async () => {\n      if (!debounce) {\n        debounce = true\n        await doc(_source, _output, _toc)\n        if (_push) {\n          console.log('Pushing documentation changes')\n          await gitPush(_source, _output, _push)\n        }\n        setTimeout(() => { debounce = false }, 100)\n      }\n    })\n  }\n})()\n\nconst gitPush = async (source, output, message) => {\n  const { promise } = spawn('git', ['log', '--format=%B', '-n', '1'])\n  const { stdout } = await promise\n  const s = stdout.trim()\n  if (s == message) {\n    await git('reset', 'HEAD~1')\n  }\n  await git('add', source, output)\n  await git('commit', '-m', message)\n  await git('push', '-f')\n}\n\nconst git = async (...args) => {\n  const { promise } = spawn('git', args, { stdio: 'inherit' })\n  await promise\n}\n"],"file":"index.js"}