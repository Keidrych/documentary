{"version":3,"sources":["../../src/bin/index.js"],"names":["LOG","DEBUG","test","process","env","NODE_DEBUG","source","_source","output","_output","toc","_toc","watch","_watch","push","_push","command","short","boolean","argv","find","a","console","log","exit","doc","justToc","ls","stream","isDirectory","Pedantry","isFile","stack","message","code","debounce","recursive","gitPush","setTimeout","promise","stdout","s","trim","git","args","stdio"],"mappings":"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","sourcesContent":["#!/usr/bin/env node\nimport { watch } from 'fs'\nimport argufy from 'argufy'\nimport { lstatSync, createReadStream } from 'fs'\nimport Pedantry from 'pedantry'\nimport { debuglog } from 'util'\nimport spawn from 'spawncommand'\nimport run from './run'\n\nconst LOG = debuglog('doc')\nconst DEBUG = /doc/.test(process.env.NODE_DEBUG)\n\nconst {\n  source: _source,\n  output: _output,\n  toc: _toc,\n  watch: _watch,\n  push: _push,\n} = argufy({\n  source: {\n    command: true,\n  },\n  toc: {\n    short: 't',\n    boolean: true,\n  },\n  watch: {\n    short: 'w',\n    boolean: true,\n  },\n  output: 'o',\n  push: {\n    short: 'p',\n  },\n})\n\nif (process.argv.find(a => a == '-p') && !_push) {\n  console.log('Please specify a commit message.')\n  process.exit(1)\n}\n\nconst doc = async (source, output, justToc = false) => {\n  if (!source) {\n    console.log('Please specify an input file.') // print usage\n    process.exit(1)\n  }\n  const ls = lstatSync(source)\n  let stream\n  if (ls.isDirectory()) {\n    stream = new Pedantry(source)\n  } else if (ls.isFile()) {\n    stream = createReadStream(source)\n  }\n  await run(stream, output, justToc)\n}\n\n(async () => {\n  try {\n    await doc(_source, _output, _toc)\n  } catch ({ stack, message, code }) {\n    if (code == 'ENOENT') {\n      console.log('File %s does not exist.', _source)\n      process.exit(2)\n    }\n    DEBUG ? LOG(stack) : console.log(message)\n  }\n  let debounce = false\n  if (_watch || _push) {\n    watch(_source, { recursive: true }, async () => {\n      if (!debounce) {\n        debounce = true\n        await doc(_source, _output, _toc)\n        if (_push) {\n          console.log('Pushing documentation changes')\n          await gitPush(_source, _output, _push)\n        }\n        setTimeout(() => { debounce = false }, 100)\n      }\n    })\n  }\n})()\n\nconst gitPush = async (source, output, message) => {\n  const { promise } = spawn('git', ['log', '--format=%B', '-n', '1'])\n  const { stdout } = await promise\n  const s = stdout.trim()\n  if (s == message) {\n    await git('reset', 'HEAD~1')\n  }\n  await git('add', source, output)\n  await git('commit', '-m', message)\n  await git('push', '-f')\n}\n\nconst git = async (...args) => {\n  const { promise } = spawn('git', args, { stdio: 'inherit' })\n  await promise\n}"],"file":"index.js"}